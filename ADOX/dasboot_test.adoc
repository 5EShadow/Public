:doctype: book
:stylesheet: ../../cctc.css
:caption:

= Exercise - DASBOOT
:doctype: book
:source-highlighter: coderay
:listing-caption: Listing
// Uncomment next line to set page size (default is Letter)
//:pdf-page-size: A4
{empty} +

== *Scenario:*

"fun.vdi" is a Virtual Disk Image of a hard drive that was captured during a raid on a terrorist compound. +
It is believed to contain intel vital to preventing an impending terrorist attack on the U.S. +
Unfortunately, the VDI has been tampered with so that our technicians can't boot the image. +
location of virtual disk image:  `/usr/share/cctc/fun.vdi` +
We recommend copying it to an alternate location, so you still have a working copy. +

Verify Your File - MD5SUM: `3bf48a722b4031cfea8eb7c7b51eb2fa` +
{empty} +

== *Activity:*

Get the image to boot properly, thereby ensuring mission success. +
There are a total of three flags for this PE, each of which is located at a point of tampering in the disk image. +
Note that this is a VDI, not an IMG, so you can't mount directly using JUST the `mount` command. +
{empty} +
 

Once you have mounted the FileSystem, the suggested workflow is:  
[square]
. Boot the VDI using qemu:  `$qemu-system-i386 fun.vdi -m 512`
. Find an obstacle in the boot process.
. shutdown the VDI.
. Mount the VDI and try to fix the problem.
. Unmount the partition and return to 1.
{empty} +
 
== *hint: *kernel panic - *Never modify a live OS*; shutdown first. 
{empty} +

== *Tip:*

http://ask.xmodulo.com/mount-qcow2-disk-image-linux.html +
http://blog.vmsplice.net/2011/02/how-to-access-virtual-machine-image.html +
http://unix.stackexchange.com/questions/35183/how-do-i-identify-which-linux-distro-is-running +
http://www.makeuseof.com/tag/how-to-password-protect-grub-entries-linux +
http://pentestmonkey.net/cheat-sheet/john-the-ripper-hash-formats +
https://help.directadmin.com/item.php?id=394 +
{empty} +

== *Find All 3 flags* +
{empty} +

== *Check Your Work:* +

`$ echo <FLAG> | md5sum` +

`5c6791f562564fdab97585840ef2aa97` +
`50a0773ee14f0c1e3844fcf125e3f0d6` +
`c96b9cdc7602a3413ff6f5c460ad3687` +
{empty} +



== *Submit* +
[square]
** DASBOOT_Student_Submission.pdf with the flags filled in. +
** If found, screenshot of foreign intel file +
{empty} +

== *Grading:* +

35% - Flag 1 collected +
+35% - Flag 2 collected +
+20% - Flag 3 / GUI +
+10% - screenshot foreign intel file +
{empty} +

== *Key learning Objectives:* +
[square]
** Familiarity with the linux boot process +
** Ability to repair the linux boot processes utilizing qemu tools +
** Understanding the possible avenues an adversary could use to exploit a system using the boot process, and bypass OS protections +

== Grading
[width="60%",cols="^2,10,10,10"]
|===
|*Part* |*Goal* |*Solution* |*Point Allocation*

|0.
|Locate the "virtual disk image" exercise file:
|`find / -type f -name fun.vdi` +
/usr/share/cctc/fun.vdi
|*0:* Exercise File located. +
*TOTAL: 0*

|1.
|Identify 1st boot obstacle "menu.lst" locked grub +
image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/locked_grub.png?raw=true["grub",height="150",width="350",align="right"] +
edit following file `/boot/grub/menu.lst`: +
image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/menu_lst.png?raw=true["menu",height="133",width="405"]
|Student either comments out the "lock" cmd or deletes it. +
  Student may either comment out the "password --md5" cmd or change the password using `openssl passwd -1 NeW_PaSsW0rD` or delete the cmd. +
*f149 #1: 372e25f23b5a8ae33c7ba203412ace30*
|*35:* Student submits flag 1. +
*TOTAL: 35*

|2.
|Identify 2nd boot obstacle "/etc/inittab" default runlevel +
image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/reboot.png?raw=true["reboot",height="100",width="350"] +
edit following file `/etc/inittab`: +
image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/inittab.png?raw=true["inittab",height="133",width="405"]
|Student changes default run-level: `id:6:initdefault` from 6 to "5" (multi-user with networking and GUI/X11). +
Student changes links in `/etc/inittab` to run-control levels to correctly reflect targets: +
  
  `l0:0:wait:/etc/init.d/knoppix-halt` +
  `l1:1:wait:/etc/init.d/rc *1*` +
  `l2:2:wait:/etc/init.d/rc *2*` +
  `l3:3:wait:/etc/init.d/rc *3*` +
  `l4:4:wait:/etc/init.d/rc 4` +
  `l5:5:wait:/etc/init.d/rc *5*` +
  `l6:6:wait:/etc/init.d/knoppix-reboot` +
  
*g00d j0b, here's #tw0: 14b305c34617fe40a0cadc6052d1023e*
|*35:* Student submits flag 2. +
*TOTAL: 35*

|3.
|Identify 3rd boot obstacle +
|*IF* student boots up right after making changes to `/etc/inittab` the startup scripts in `/etc/rc[0-6].d` will revert all changes to `/etc/inittab`. +
After Student reboots, they discover thier changes have been reverted, and begin further investigation, discovering the `/etc/rc[0-6].d` files contain revert scripts. +
Using command: +
`find /tmp/mount/etc/ -maxdepth 1 -type d -name "rc*" -exec tree -L 2 -C {} \;` students tree all startup scripts in the `/etc/rc[0-6].d` files. +
Using command: +
`find /tmp/mount/etc/rc* -maxdepth 1 -type l -exec readlink -f {} 2>/dev/null \;` students identify exact location of linked files: +

`/opt/bootlocal.sh` +
`/tmp/mount/etc/init.d/desktop.lua` +
`/tmp/mount/etc/init.d/devpts.sh` +
`/tmp/mount/etc/init.d/dsl-config` +
`/tmp/mount/etc/init.d/dsl-restore.sh` +
`/tmp/mount/etc/init.d/knoppix-autoconfig` +
`/tmp/mount/etc/init.d/knoppix-halt` +
`/tmp/mount/etc/init.d/knoppix-reboot` +
`/tmp/mount/etc/init.d/lprng` +
`/tmp/mount/etc/init.d/nfs-common` +
`/tmp/mount/etc/init.d/pcmcia` +
`/tmp/mount/etc/init.d/ppp_move.sh` +
`/tmp/mount*/etc/kek*` +
`/tmp/mount*/etc/lel*` +
`/tmp/mount*/etc/redirect*` +

Of interest, in the output, are the files originating from `/etc` that are not process daemons (`/etc/init.d/\*`): +
`/etc/{kek,lel}` and `/etc/redirect` +

image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/kek.png?raw=true["inttab",height="133",width="405"] +

image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/lel.png?raw=true["inttab",height="133",width="405"] +

image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/redirect.png?raw=true["inttab",height="133",width="405"] +

image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/art.png?raw=true["art",height="133",width="405"] +

Rebooting the image after `/etc/{kek,lel}`, and `/etc/redirect` have been subdued, reveals the final GUI/X11 flag: +

*f04dcc0423c9*
|*20:* Student submits flag 1. +
*TOTAL: 20*

|4.
|Identify Intel File / Final Flag: +
|student runs command: +
`find ./ -type f -name "\*.jpg" -exec cp {} /tmp/pics \;` and `find ./ -type f -name "\*.png" -exec cp {} /tmp/pics \;` +
student runs command: +
`firefox /tmp/pic/flag5.jpg` and reveals final intel file/final flag: +

image:https://github.com/D4NP0UL1N/Public/blob/master/ADOX/pics/intel.png?raw=true["intel",height="133",width="405"] +

*7<!xaK(s2`AqZX`z*
|*10:* Submit Screenshot. +
*TOTAL: 10*
|===
// end::grading[]
// end::solution[]
